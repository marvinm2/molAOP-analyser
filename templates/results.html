<!DOCTYPE html>
<html>
<head>
    <title>KE Enrichment Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <!-- Cytoscape core -->
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

    <!-- Dagre layout extension -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <script>
    cytoscape.use(window.cytoscapeDagre);
    </script>



    <style>
        .content-box {
            width: 95%;
            max-width: none;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            white-space: nowrap;
        }
        th {
            background-color: #307BBF;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .explanation {
            font-size: 14px;
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="page-container">
    <header>
        <h1>Molecular Adverse Outcome Pathway Analyser</h1>
    </header>
    <div class="content-box">
        <h1>KE Enrichment Results</h1>

        <div class="explanation">
            <p><strong>Gene Identifier Type:</strong> {{ id_type }}</p>
            <p>This table presents enrichment results for Key Events (KEs) based on your transcriptomic dataset.</p>
            <p>Each row corresponds to a KE, showing the degree of overlap between its associated gene set and your differentially expressed genes.</p>

            <ul>
                <li><strong>Overlap Genes:</strong> Genes shared between the KE set and your dataset.</li>
                <li><strong># Overlap:</strong> Number of overlapping genes.</li>
                <li><strong>p-value:</strong> Statistical significance (Fisher's exact test).</li>
                <li><strong>FDR:</strong> Adjusted p-value using the Benjamini-Hochberg procedure.</li>
            </ul>

            <p>The enrichment was calculated using all genes in your uploaded dataset as the background universe.</p>
            <p><strong>Background gene set size:</strong> {{ background_size }}</p>
        </div>

        <!-- Report Generation Section -->
        <div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-left: 5px solid #307BBF; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #29235C;">📊 Generate Analysis Report</h3>
            <p style="font-size: 14px; color: #555; margin-bottom: 15px;">
                Create a comprehensive report including experiment metadata, analysis settings, and results for documentation or sharing.
            </p>
            
            <form id="reportForm" action="{{ url_for('generate_report') }}" method="post" style="display: inline-flex; gap: 10px; align-items: center;" onsubmit="captureNetworkPNG()">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <!-- Hidden fields with analysis data -->
                <input type="hidden" name="filename" value="{{ metadata.get('filename', 'unknown') }}">
                <input type="hidden" name="gene_count" value="{{ background_size }}">
                <input type="hidden" name="significant_genes" value="{{ metadata.get('significant_genes', 0) }}">
                <input type="hidden" name="aop_id" value="{{ metadata.get('aop_id', '') }}">
                <input type="hidden" name="aop_label" value="{{ metadata.get('aop_label', '') }}">
                <input type="hidden" name="logfc_threshold" value="{{ threshold }}">
                <input type="hidden" name="pval_cutoff" value="0.05">
                <input type="hidden" name="id_column" value="{{ metadata.get('id_column', '') }}">
                <input type="hidden" name="fc_column" value="{{ metadata.get('fc_column', '') }}">
                <input type="hidden" name="pval_column" value="{{ metadata.get('pval_column', '') }}">
                <input type="hidden" name="id_type" value="{{ id_type }}">
                <textarea name="enrichment_results" style="display: none;">{{ table_json | safe }}</textarea>
                <textarea name="volcano_data" style="display: none;">{{ volcano_json | safe }}</textarea>
                <textarea name="network_data" style="display: none;">{{ network_json | safe }}</textarea>
                <textarea name="network_png" id="network-png-data" style="display: none;"></textarea>
                <!-- Metadata fields for report generation -->
                <input type="hidden" name="dataset_id" value="{{ metadata.get('dataset_id', '') }}">
                <input type="hidden" name="stressor" value="{{ metadata.get('stressor', '') }}">
                <input type="hidden" name="dosing" value="{{ metadata.get('dosing', '') }}">
                <input type="hidden" name="owner" value="{{ metadata.get('owner', '') }}">
                <input type="hidden" name="description" value="{{ metadata.get('description', '') }}">
                
                <label for="reportFormat" style="font-weight: bold; color: #29235C;">Format:</label>
                <select name="format" id="reportFormat" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                    <option value="pdf">PDF Report</option>
                    <option value="html">HTML Report</option>
                </select>
                
                <button type="submit" style="background-color: #E6007E; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    📄 Generate Report
                </button>
            </form>
            
            <p style="font-size: 12px; color: #666; margin-top: 10px; font-style: italic;">
                💡 Reports include all experiment metadata, analysis parameters, and enrichment results for comprehensive documentation.
            </p>
        </div>

        <div style="overflow-x: auto;">
            <table id="resultsTable" class="display">
                <thead>
                    <tr>
                        {% set column_names = {
                            'Title': 'Key Event Title',
                            'p_value': 'P-value', 
                            'FDR': 'FDR',
                            'num_overlap': '# Overlap',
                            'pct_sig_in_KE': '% Enrichment',
                            'total_KE_genes_in_dataset': 'KE Gene Count',
                            'odds_ratio': 'Odds Ratio',
                            'overlap': 'Overlapping Genes',
                            'KE': 'KE ID',
                            'sig_in_KE': 'Sig in KE',
                            'sig_not_KE': 'Sig not KE',
                            'non_sig_in_KE': 'Non-sig in KE',
                            'non_sig_not_KE': 'Non-sig not KE'
                        } %}
                        {% for col in table[0].keys() %}
                        <th>{{ column_names.get(col, col) }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table %}
                    <tr>
                        {% for col, val in row.items() %}
                        <td>
                            {% if col in ['p_value', 'FDR'] %}
                                {% if val < 0.001 %}
                                    {{ "%.2e"|format(val) }}
                                {% else %}
                                    {{ "%.4f"|format(val) }}
                                {% endif %}
                            {% elif col == 'odds_ratio' and val != 'NA' %}
                                {{ "%.2f"|format(val) }}
                            {% elif col == 'pct_sig_in_KE' %}
                                {{ "%.1f"|format(val) }}%
                            {% else %}
                                {{ val }}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <script>
        $(document).ready(function() {
            $('#resultsTable').DataTable({
                dom: 'Bfrtip',
                autoWidth: true,
                buttons: ['copy', 'csv', 'excel', 'print']
            });
        });
        </script>

        
    
<h2>AOP Network</h2>
<p style="font-size: 15px; color: #444; max-width: 800px; text-align: left;">
    This network diagram shows how the Key Events (KEs) are connected within the selected Adverse Outcome Pathway (AOP).
    <br><br>
    <strong>Color coding:</strong><br>
    – Node color reflects gene-level log<sub>2</sub> fold change.<br>
    – KE nodes with a <span style="color:red;">red border</span> are statistically significant (FDR &lt; 0.05).<br>
    – Gene nodes with a <span style="color:green;">green border</span> are also significantly affected.
    <br><br>
    Use the buttons below the network to add gene nodes, toggle their visibility, reset the view, or download the network.
</p>

<!-- Network Legend -->
<div style="display: flex; justify-content: center; margin: 20px 0;">
    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-width: 800px;">
        <h3 style="margin-top: 0; margin-bottom: 15px; color: #29235C; font-size: 16px;">Network Legend</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 13px;">
            <!-- Node Types -->
            <div>
                <strong style="color: #29235C;">Key Event Types:</strong>
                <div style="margin-top: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 20px; height: 20px; background: #b3e6b3; border-radius: 50%; border: 1px solid #999; margin-right: 8px;"></div>
                        <span>MIE (Molecular Initiating Event)</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 20px; height: 20px; background: #ffd9b3; border-radius: 50%; border: 1px solid #999; margin-right: 8px;"></div>
                        <span>Intermediate Key Event</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 20px; height: 20px; background: #f4b3b3; border-radius: 50%; border: 1px solid #999; margin-right: 8px;"></div>
                        <span>AO (Adverse Outcome)</span>
                    </div>
                </div>
            </div>
            
            <!-- Significance and Gene Coloring -->
            <div>
                <strong style="color: #29235C;">Significance & Expression:</strong>
                <div style="margin-top: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 20px; height: 20px; background: #ffd9b3; border-radius: 50%; border: 3px solid red; margin-right: 8px;"></div>
                        <span>Significant KE (FDR < 0.05)</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(to right, #2c7bb6, #ffffcc, #d73027); border: 2px solid green; border-radius: 50%; margin-right: 8px;"></div>
                        <span>Significant Gene (colored by log₂FC)</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 2px; height: 15px; background: #ccc; margin-right: 8px; margin-left: 9px;"></div>
                        <span>KE-gene connections</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Color Scale -->
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
            <strong style="color: #29235C; font-size: 13px;">Gene Expression Scale (log₂FC):</strong>
            <div style="display: flex; align-items: center; margin-top: 5px;">
                <span style="font-size: 11px; margin-right: 5px;">-2</span>
                <div style="width: 100px; height: 12px; background: linear-gradient(to right, #2c7bb6, #abd9e9, #ffffcc, #fdae61, #d73027); border: 1px solid #999;"></div>
                <span style="font-size: 11px; margin-left: 5px;">+2</span>
                <span style="font-size: 11px; margin-left: 10px; color: #666;">Downregulated ← → Upregulated</span>
            </div>
        </div>
    </div>
</div>

<div id="cy" style="width: 100%; height: 800px; border: 2px solid #ccc; border-radius: 8px; background: white;"></div>

<div style="display: flex; justify-content: center; gap: 10px; margin: 10px;">
  <button onclick="addGeneNodes()">+ Add Gene Nodes</button>
  <button onclick="toggleGenes()">Toggle Gene Visibility</button>
  <button onclick="cy.reset(); cy.fit();">Reset View</button>
  <button onclick="downloadPNG()">Download PNG</button>
  <button onclick="downloadJSON()">Download Network</button>
</div>

<!-- Network Statistics Table -->
<div style="margin: 30px auto; max-width: 600px;">
    <h3 style="color: #29235C; text-align: center; margin-bottom: 15px;">📊 Network Statistics</h3>
    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
        <table id="networkStatsTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <tbody>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">Total Key Events</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-total-kes">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">Significant Key Events</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-sig-kes">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">Total Gene Nodes</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-total-genes">0</td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">Significant Gene Nodes</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-sig-genes">0</td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">KE-KE Relationships</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-ke-edges">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">KE-Gene Connections</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-gene-edges">0</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #29235C;">Total Network Edges</td>
                    <td style="padding: 8px 0; text-align: right;" id="stat-total-edges">-</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

</div>

<script>
const network = {{ network_json | safe }};
const keToGenes = {{ ke_gene_json | safe }};

// --- Network Statistics Functions ---
function updateNetworkStats() {
    const keNodes = cy.nodes().not('.gene');
    const geneNodes = cy.nodes('.gene');
    const sigKeNodes = cy.nodes('.significant').not('.gene');
    const sigGeneNodes = cy.nodes('.gene.significant');
    const keEdges = cy.edges().not('.gene-link');
    const geneEdges = cy.edges('.gene-link');
    
    document.getElementById('stat-total-kes').textContent = keNodes.length;
    document.getElementById('stat-sig-kes').textContent = sigKeNodes.length;
    document.getElementById('stat-total-genes').textContent = geneNodes.length;
    document.getElementById('stat-sig-genes').textContent = sigGeneNodes.length;
    document.getElementById('stat-ke-edges').textContent = keEdges.length;
    document.getElementById('stat-gene-edges').textContent = geneEdges.length;
    document.getElementById('stat-total-edges').textContent = cy.edges().length;
}

// --- Gradient function used for gene node background and fallback KE nodes ---
function defaultLogFCColor(logfc) {
    const fc = parseFloat(logfc) || 0;
    const fcClamped = Math.max(-1, Math.min(1, fc));
    const norm = (fcClamped + 1) / 2;
    const interpolate = (start, end, t) => Math.round(start + (end - start) * t);

    let r, g, b;
    if (norm < 0.5) {
        const t = norm * 2;
        r = interpolate(44, 255, t);
        g = interpolate(123, 255, t);
        b = interpolate(182, 255, t);
    } else {
        const t = (norm - 0.5) * 2;
        r = interpolate(255, 215, t);
        g = interpolate(255, 25, t);
        b = interpolate(255, 28, t);
    }
    if (fc === 0) return '#ccc';  // fallback grey

    return `rgb(${r},${g},${b})`;
}

const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [...network.nodes, ...network.edges],
    wheelSensitivity: 0.1,
    style: [
    {
        selector: 'node',
        style: {
            'label': 'data(label)',
            'color': '#000',
            'font-size': 12,
            'text-valign': 'center',
            'text-halign': 'center',
            'width': 45,
            'height': 45
        }
    },
    {
        selector: 'node[ke_type = "MIE"]',
        style: {
            'background-color': '#b3e6b3'
        }
    },
    {
        selector: 'node[ke_type = "AO"]',
        style: {
            'background-color': '#f4b3b3'
        }
    },
    {
        selector: 'node[ke_type = "intermediate"]',
        style: {
            'background-color': '#ffd9b3'
        }
    },
    {
        selector: 'node.significant',
        style: {
            'border-width': 3,
            'border-color': 'red'
        }
    },
    {
        selector: 'node.gene.significant',
        style: {
            'border-color': 'green'
        }
    },
    {
        selector: 'node.gene',
        style: {
            'shape': 'ellipse',
            'label': 'data(label)',
            'width': 20,
            'height': 20,
            'font-size': 8,
            'color': '#000',
            'background-color': ele => defaultLogFCColor(ele.data('logfc'))
        }
    },
    {
        selector: 'edge',
        style: {
            'width': 2,
            'line-color': '#999',
            'target-arrow-color': '#999',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier'
        }
    },
    {
        selector: 'edge.gene-link',
        style: {
            'line-color': '#ccc',
            'width': 1,
            'target-arrow-shape': 'none',
            'curve-style': 'bezier'
        }
    }
],
    layout: {
        name: 'dagre',
        rankDir: 'TB'
    }
});

// Update network statistics on initial load
updateNetworkStats();
</script>

<script>
let genesVisible = true;

function addGeneNodes() {
    const addedGenes = new Set();

    Object.entries(keToGenes).forEach(([ke, geneList]) => {
        geneList.forEach(geneObj => {
            const gene = geneObj.id;
            const logfc = geneObj.log2FC || 0;
            const isSignificant = geneObj.significant === true;

            const nodeClasses = isSignificant ? 'gene significant' : 'gene';

            if (!addedGenes.has(gene)) {
                cy.add({
                    group: 'nodes',
                    data: {
                        id: gene,
                        label: gene,
                        logfc: logfc
                    },
                    classes: nodeClasses
                });
                addedGenes.add(gene);
            }

            cy.add({
                group: 'edges',
                data: {
                    id: ke + '_' + gene,
                    source: gene,
                    target: ke
                },
                classes: 'gene-link'
            });
        });
    });

    cy.layout({ name: 'cose', animate: true }).run();
    
    // Update network statistics after adding genes
    updateNetworkStats();
}


function toggleGenes() {
    const geneNodes = cy.nodes('.gene');
    const geneEdges = cy.edges('.gene-link');

    if (genesVisible) {
        geneNodes.hide();
        geneEdges.hide();
    } else {
        geneNodes.show();
        geneEdges.show();
    }

    genesVisible = !genesVisible;
    
    // Update network statistics after toggling gene visibility
    updateNetworkStats();
}

function downloadPNG() {
  const png = cy.png({ full: true, scale: 2 });
  const link = document.createElement('a');
  link.href = png;
  link.download = 'aop_network.png';
  link.click();
}
function downloadJSON() {
  const json = cy.json();
  const blob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'aop_network.cyjs';
  link.click();
}

function captureNetworkPNG() {
  // First ensure genes are added to the network for complete visualization
  if (cy.nodes('.gene').length === 0) {
    console.log('Adding genes to network before capture...');
    addGeneNodes();
    // Wait for layout to complete
    setTimeout(() => captureNetworkImage(), 1000);
  } else {
    captureNetworkImage();
  }
}

function captureNetworkImage() {
  // Capture the current network as PNG for PDF report with high quality
  try {
    const png = cy.png({ 
      full: true, 
      scale: 2, // Higher scale for better quality
      bg: 'white'
      // Remove maxWidth/maxHeight constraints to prevent stretching
    });
    document.getElementById('network-png-data').value = png;
    console.log('Network PNG captured for PDF report with genes included');
  } catch (error) {
    console.warn('Failed to capture network PNG:', error);
    document.getElementById('network-png-data').value = '';
  }
}

</script>


<footer>
        <div class="footer-content">
            &copy; 2025 Molecular AOP Analyser
        </div>
    </footer>
</div>
</body>

</html>
